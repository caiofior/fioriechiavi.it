<link rel="stylesheet" href="<?php echo $GLOBALS['db']->config->baseUrl;?>/style/general/index.css">
<form method="post" action="#">
   <label for="taxasearch">Cerca: </label>
   <input id="taxasearch" name="taxasearch" value="">
</form>
<?php
$taxa = $this->object;
$dico = $taxa->dico;
$title = $GLOBALS['db']->config->siteName;
if ($taxa->getData('name') != '') {
    $title = $taxa->getRawData('taxa_kind_initials').' '.$taxa->getData('name');
}
?>
<h1><?php echo $title; ?></h1>
<?php
if ($taxa->getData('name') != '') {
   $taxaParentColl = $taxa->getParentColl();
   foreach(array_reverse($taxaParentColl->getItems()) as $key => $taxaParent) : ?>
   <a href="<?php echo $GLOBALS['db']->config->baseUrl;?>/index.php?id=<?php echo $taxaParent->getData('id');?>">
      <h<?php echo 1+$taxaParentColl->count()-$key;?>><?php echo $taxaParent->getRawData('taxa_kind_initials').' '.$taxaParent->getData('name'); ?></h<?php echo 1+$taxaParentColl->count()-$key;?>>   
   </a>
   <?php
   endforeach;
}
?>
<?php
if ($taxa->getData('description') != '') :
echo $taxa->getData('description');
$regionColl = $taxa->getRegionColl();
$regionColl = $regionColl->filterByAttributeValue('1','selected');
if ($regionColl->count() >0) : ?>
<div class="mapContainer">
   <img class="baseMap" src="<?php echo $GLOBALS['db']->config->baseUrl;?>/images/map/italia.png">
   <?php foreach($regionColl->getItems() as $region) : ?>
   <img class="mapRegion" src="<?php echo $GLOBALS['db']->config->baseUrl;?>/images/map/<?php echo $region->getData('id');?>.png">
   <?php endforeach; ?>
</div>
<?php endif;
$attributeColl = $taxa->getTaxaAttributeColl();
   if ($attributeColl->count() > 0) : ?>
<div class="attribute_list">
      <?php foreach($attributeColl->getItems() as $attribute) : ?>
      <p>
            <?php echo $attribute->getData('name');?> :
            <span><?php echo $attribute->getRawData('value');?></span>
      </p>
      <?php endforeach; ?>
</div>
   <?php endif;
   $imageColl = $taxa->getTaxaImgeColl();
   if ($imageColl->count() > 0) : ?>
<div class="image_list">
      <?php foreach($imageColl->getItems() as $image) : ?>
      <div>
            <img src="<?php echo $image->getUrl();?>"/>
      </div>
      <?php endforeach; ?>
</div>
   <?php endif;
endif;
$dicoItemColl = $dico->getDicoItemColl();
$positions = array();
$lastPosition = 0;
foreach ($dicoItemColl->getItems() as $dicoItem): 
   $lastCharacter = substr($dicoItem->getData('id'),-1);
   if ($lastCharacter == 0) {
      $lastPosition++;
      $positions[substr($dicoItem->getData('id'),0,-1).'0']= $lastPosition;
      $positions[substr($dicoItem->getData('id'),0,-1).'1']= $lastPosition;
   }
   $label = $dicoItem->getData('text');
?>
<div>
   <?php echo str_repeat('&#160;', strlen($dicoItem->getData('id'))-1); ?>
   <?php echo $positions[$dicoItem->getData('id')]; ?>
   <span id="d<?php echo $dicoItem->getData('id'); ?>">
      <?php echo $label;
      if (is_numeric($dicoItem->getData('taxa_id'))) : ?>
      <a href="<?php echo $GLOBALS['db']->config->baseUrl;?>?id=<?php echo $dicoItem->getData('taxa_id'); ?>"><?php echo $dicoItem->getRawData('initials'); ?> <?php echo $dicoItem->getRawData('name'); ?></a>
      <?php endif; ?>
   </span>
</div>
<?php endforeach; 
$searchTerm = '';
if (is_numeric($taxa->getData('id'))) {
   $searchTerm = $taxa->getData('name');
}
?>
<script>
var searchTerm = "<?php echo $searchTerm; ?>";
var cx = "<?php echo $GLOBALS['db']->config->search->cx; ?>";
var key = "<?php echo $GLOBALS['db']->config->search->key; ?>";
</script>
<h2>Immagini dal web</h2>
<div id="imageSnipets"></div>
<div class="clear"/>
<? $newTaxaColl  = new \flora\taxa\TaxaColl($GLOBALS['db']);
$newTaxaColl->loadAll(array(
    'iDisplayStart'=>0,
    'iDisplayLength'=>2,
    'sColumns'=>'change_datetime',
    'iSortingCols'=>'1',
    'iSortCol_0'=>'0',
    'sSortDir_0'=>'DESC'
));
$newTaxaColl->shuffle();
if($newTaxaColl->count() > 0): ?>
<div id="newtaxa">
   <h2> Ultime novit√† </h2>
   <div class="latestTaxa">
   <?php foreach($newTaxaColl->getItems() as $newTaxa) : 
      $image = null;
      $imageColl = $newTaxa->getTaxaImgeColl();
      $imageColl->shuffle();
      if ($imageColl->count() > 0) {
         $image = $imageColl->getFirst();
      }
      ?>
      <div>
         <?php if (is_object($image)) : ?>
            <img src="<?php echo $image->getUrl();?>"/>
         <?php endif; ?>
         <br/>
         <a href="<?php echo $GLOBALS['db']->config->baseUrl;?>/index.php?id=<?php echo $newTaxa->getData('id');?>"><?php echo $newTaxa->getRawData('taxa_kind_initials').' '.$newTaxa->getData('name') ?></a>

      </div>
   <?php endforeach;?>
   </div>
</div>
<div class="clear"/>
<?php endif; ?>
<?php 
   if ($taxa->getData('id') == '') :
      $content = new \content\content\Content($GLOBALS['db']);
   $content->loadFromLabel('root_category'); ?>
   <div>
   <h2>
      <a class="more_info" href="#"><?php echo $content->getData('title');?></a>
   </h2>
   <p>
      <a class="more_info" href="#"><?php echo $content->getData('abstract');?></a>
   </p>
   <div style="display:none;">
      <?php echo $content->getData('content');?>
   </div>
   </div>

<?php endif;?>
