<div id="fb-root"></div>
<form method="post" action="#">
   <label for="taxasearch">Cerca: </label>
   <input id="taxasearch" name="taxasearch" value="">
   <span><?php $moreDicoItemTaxaColl  = new \flora\taxa\TaxaColl($GLOBALS['db']);
    $moreDicoItemTaxaColl->loadAll(array(
    'iDisplayStart'=>0,
    'iDisplayLength'=>4,
    'moreDicoItems'=>'Fam.:Gen.'
));
    if($moreDicoItemTaxaColl->count() > 0): ?>
    Taxa più rappresentati:  
    <?php foreach($moreDicoItemTaxaColl->getItems() as $moreDicoItemTaxa) : ?>
    <a href="<?php echo $GLOBALS['db']->config->baseUrl;?>/index.php?id=<?php echo $moreDicoItemTaxa->getData('id');?>"><?php echo $moreDicoItemTaxa->getRawData('taxa_kind_initials').' '.$moreDicoItemTaxa->getData('name') ?></a>
<?php endforeach;
endif;
?></span>
</form>
<?php
$taxa = $this->object;
$dico = $taxa->dico;
$title = $GLOBALS['db']->config->siteName;
if ($taxa->getData('name') != '') :
    $title = $taxa->getRawData('taxa_kind_initials').' '.$taxa->getData('name'); 
require (__DIR__.DIRECTORY_SEPARATOR.'social.php');
endif; ?>
<h1><?php echo $title; ?></h1>
<?php
if ($taxa->getData('name') != '') : 
   $taxaParentColl = $taxa->getParentColl();
   foreach(array_reverse($taxaParentColl->getItems()) as $key => $taxaParent) : ?>
   <a href="<?php echo $GLOBALS['db']->config->baseUrl;?>/index.php?id=<?php echo $taxaParent->getData('id');?>">
      <h<?php echo 1+$taxaParentColl->count()-$key;?>><?php echo $taxaParent->getRawData('taxa_kind_initials').' '.$taxaParent->getData('name'); ?></h<?php echo 1+$taxaParentColl->count()-$key;?>>   
   </a>
   <?php
   endforeach;
endif;
?>
<?php
if ($taxa->getData('description') != '') :
echo $taxa->getData('description');
require (__DIR__.DIRECTORY_SEPARATOR.'map.php'); 
$attributeColl = $taxa->getTaxaAttributeColl();
   if ($attributeColl->count() > 0) : ?>
<div class="attribute_list">
      <?php foreach($attributeColl->getItems() as $attribute) :
         switch ($attribute->getData('name')) : 
            case 'Inizio fioritura' :
            break;
            case 'Fine fioritura' :
            break;
            case 'Limite altitudinale inferiore' :
            break;
            case 'Limite altitudinale superiore' :
            break;
            case 'Diffusione' : ?>
      <p>
            <?php echo $attribute->getData('name');?> :
            <span>
               <?php switch($attribute->getRawData('value')) :
                  case 'Specie endemica':?>
               ●
               <?php
                  break;
               endswitch;
               echo $attribute->getRawData('value');?>
            </span>
      </p>
            <?php 
            break;
          case 'Ciclo riproduttivo' : ?>
      <p>
            <?php echo $attribute->getData('name');?> :
            <span>
               <?php switch($attribute->getRawData('value')) :
                  case 'Annuale':?>
               ☉
               <?php
                  break;
                  case 'Biennale':?>
               ⚇
               <?php
                  break;
               endswitch;
               echo $attribute->getRawData('value');?>
            </span>
      </p>
            <?php 
            break;
            case 'Portamento' : ?>
      <p>
            <?php echo $attribute->getData('name');?> :
            <span>
               <?php switch($attribute->getRawData('value')) :
                  case 'Pianta perenne erbacea':?>
               ↓
               <?php
                  break;
                  case 'Cespuglio':?>
               ⏉
               <?php
                  break;
                  case 'Albero':?>
               ☨
               <?php
                  break;
               endswitch;
               echo $attribute->getRawData('value');?>
            </span>
      </p>
            <?php 
            break;
            default:
            ?>
      <p>
            <?php echo $attribute->getData('name');?> :
            <span><?php echo $attribute->getRawData('value');?></span>
      </p>
      <?php
            break;
         endswitch;
      endforeach; ?>
</div>
<div class="clear"></div>
<?php  
if (
        $attributeColl->filterByAttributeValue('Limite altitudinale inferiore','name')->getFirst()->getRawData('value') != '' &&
        $attributeColl->filterByAttributeValue('Limite altitudinale superiore','name')->getFirst()->getRawData('value') != ''
    ) {
      require (__DIR__.DIRECTORY_SEPARATOR.'altitude.php');
   }
if (
        $attributeColl->filterByAttributeValue('Inizio fioritura','name')->getFirst()->getRawData('value') != '' &&
        $attributeColl->filterByAttributeValue('Fine fioritura','name')->getFirst()->getRawData('value') != ''
    ) {
      require (__DIR__.DIRECTORY_SEPARATOR.'flowering.php');
   } ?>
   <?php endif;
   $imageColl = $taxa->getTaxaImgeColl();
   if ($imageColl->count() > 0) : ?>
<div class="image_list">
      <?php foreach($imageColl->getItems() as $key=>$image) : ?>
      <div>
            <img src="<?php echo $GLOBALS['db']->config->staticUrl.$image->getUrl();?>" alt="Immagine <?php echo $key; ?>"/>
      </div>
      <?php endforeach; ?>
</div>
   <?php endif; ?>
<div>
<a class="blank" rel="nofollow" href="http://it.wikipedia.org/wiki/<?php echo urlencode(str_replace(' ', '_', $taxa->getData('name')));?>">Cerca su Wikipedia</a>
<a class="blank" rel="nofollow" href="https://www.google.it/#q=site:www.actaplantarum.org+<?php echo urlencode($taxa->getData('name'));?>">Cerca scheda su Acta plantorum</a>
</div>
<?php endif;
$dicoItemColl = $dico->getDicoItemColl();
$positions = array();
$lastPosition = 0;
foreach ($dicoItemColl->getItems() as $dicoItem): 
   $lastCharacter = substr($dicoItem->getData('id'),-1);
   if ($lastCharacter == 0) {
      $lastPosition++;
      $positions[substr($dicoItem->getData('id'),0,-1).'0']= $lastPosition;
      $positions[substr($dicoItem->getData('id'),0,-1).'1']= $lastPosition;
   }
   $label = $dicoItem->getData('text');
?>
<div>
   <?php echo str_repeat('&#160;', strlen($dicoItem->getData('id'))-1); ?>
   <?php echo $positions[$dicoItem->getData('id')]; ?>
   <span id="d<?php echo $dicoItem->getData('id'); ?>">
      <?php echo $label;
      if (is_numeric($dicoItem->getData('taxa_id')) && $dicoItem->getRawData('status') == 0) : ?>
      <?php echo $dicoItem->getRawData('initials'); ?> <?php echo $dicoItem->getRawData('name'); ?>
      <?php elseif (is_numeric($dicoItem->getData('taxa_id')) && $dicoItem->getRawData('status') == 1) : ?>
      <a href="<?php echo $GLOBALS['db']->config->baseUrl;?>?id=<?php echo $dicoItem->getData('taxa_id'); ?>"><?php echo $dicoItem->getRawData('initials'); ?> <?php echo $dicoItem->getRawData('name'); ?></a>
      <?php endif; ?>
   </span>
</div>
<?php endforeach; 
$searchTerm = '';
if (is_numeric($taxa->getData('id'))) {
   $searchTerm = $taxa->getData('name');
}
?>
<script>
//<![CDATA[
var searchTerm = "<?php echo $searchTerm; ?>";
var cx = "<?php echo $GLOBALS['db']->config->search->cx; ?>";
var key = "<?php echo $GLOBALS['db']->config->search->key; ?>";
//]]>
</script>
<h2>Immagini dal web</h2>
<div id="imageSnipets"></div>
<div class="clear"></div>
<?php $newTaxaColl  = new \flora\taxa\TaxaColl($GLOBALS['db']);
$newTaxaColl->loadAll(array(
    'iDisplayStart'=>0,
    'iDisplayLength'=>2,
    'sColumns'=>'change_datetime',
    'iSortingCols'=>'1',
    'iSortCol_0'=>'0',
    'sSortDir_0'=>'DESC',
    'images'=>1
));
$newTaxaColl->shuffle();
if($newTaxaColl->count() > 0): ?>
<div id="newtaxa">
   <h2> Ultime novità </h2>
   <div class="latestTaxa">
   <?php foreach($newTaxaColl->getItems() as $newTaxa) : 
      $image = null;
      $imageColl = $newTaxa->getTaxaImgeColl();
      $imageColl->shuffle();
      if ($imageColl->count() > 0) {
         $image = $imageColl->getFirst();
      }
      ?>
      <div>
         <?php if (is_object($image)) : ?>
            <img src="<?php echo $GLOBALS['db']->config->staticUrl.$image->getUrl();?>" alt="<?php echo $newTaxa->getData('name');?>"/>
         <?php endif; ?>
         <br/>
         <a href="<?php echo $GLOBALS['db']->config->baseUrl;?>/index.php?id=<?php echo $newTaxa->getData('id');?>"><?php echo $newTaxa->getRawData('taxa_kind_initials').' '.$newTaxa->getData('name') ?></a>

      </div>
   <?php endforeach;?>
   </div>
</div>
<div class="clear"></div>
<?php endif; ?>
<?php 
   if ($taxa->getData('id') == '') :
      $content = new \content\content\Content($GLOBALS['db']);
   $content->loadFromLabel('root_category'); ?>
   <div>
   <h2>
      <a class="more_info" href="#"><?php echo $content->getData('title');?></a>
   </h2>
   <p>
      <a class="more_info" href="#"><?php echo $content->getData('abstract');?></a>
   </p>
   <div style="display:none;">
      <?php echo $content->getData('content');?>
   </div>
   </div>
<?php elseif($taxa->getData('description') == '' && $dicoItemColl->count() == 0) :
   $content = new \content\content\Content($GLOBALS['db']);
   $content->loadFromLabel('empty_taxa');?>
   <div>
   <h2>
      <a class="more_info" href="#"><?php echo $content->getData('title');?></a>
   </h2>
   <div>
      <?php echo $content->getData('content');?>
   </div>
   </div>
<?php endif;?>
